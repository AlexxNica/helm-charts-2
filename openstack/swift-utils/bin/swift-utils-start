#!/bin/bash

# acceptable values: proxy-server, object-auditor, container-sync, etc.
# (basically any Swift executable without the "swift-" prefix)
COMPONENT_NAME="$1"
if [ -z "${COMPONENT_NAME}" ]; then
    echo "$0: missing component name" >&2
    exit 1
fi

# if this is a storage service, keep restarting until storage becomes available
if [ -d /srv/node -a ! -f /swift-drive-state/flag-ready ]; then
    echo "waiting for /swift-drive-state/flag-ready" >&2
    exit 1
fi

# set some env variables from the openstack env properly based on env
. /swift-utils-bin/common.sh

# create the marker file for the unmount-helper that marks when this service was started
mkdir -p /swift-drive-state/service-startup-time
MARKER="/swift-drive-state/service-startup-time/$1"
touch "${MARKER}"

# on Ubuntu, python does not recognize the system certificate bundle
export OS_CACERT=/etc/ssl/certs/ca-certificates.crt
export REQUESTS_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt

# unset all proxy settings
unset http_proxy https_proxy no_proxy

# function to initialize syslog-stdout (default) or busybox-syslogd
function start_rsyslog {
    if hash syslog-stdout &>/dev/null; then
        syslog-stdout &
    else
        /sbin/syslogd -O /proc/1/fd/1
    fi
}

# function to run a cronjob
# syntax: every <MINUTES> <COMMAND> [<ARG>...]
function every {
    # when job fails, exit to prompt a container restart
    set -e
    # remove interval from argument list
    INTERVAL="$1"
    shift
    # main loop
    while true; do
        "$@"
        sleep "${INTERVAL}"
    done
}

# we need to find where Swift is installed in our $PATH, because the $PATH variable is reset by sudo(1)
SWIFT_BIN_PATH="$(dirname "$(which swift-proxy-server)")"

function _start_application {
    case "$COMPONENT_NAME" in
        account-caretaker-collect)
            bash /swift-utils-bin/unmount-helper "${MARKER}" &
            every 86400 "${SWIFT_BIN_PATH}/swift-account-caretaker" -c /caretaker-etc/config.yaml -l info collect
            ;;
        account-caretaker-mergify)
            every 86400 "${SWIFT_BIN_PATH}/swift-account-caretaker" -c /caretaker-etc/config.yaml -l info mergify --history=30
            ;;
    esac
}

function start_application {
    if [ "$DEBUG_CONTAINER" = "true" ]
    then
        tail -f /dev/null
    else
        _start_application
    fi
}

start_application
